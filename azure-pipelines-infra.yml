# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- none

pool:
  vmImage: ubuntu-latest

variables:
  - group: InfraPipelinelVars
  - group: SubscriptionVars

stages:
  - stage: DevDeployment
    displayName: Deploy Dev Infrastructure
    jobs:
      - job: DeployInfrastructure
        displayName: Deploy Infrastructure Bicep
        steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              deploymentScope: 'Resource Group'
              connectedServiceName: $(ServiceConnectionName)
              location: $(DeploymentDefaultLocation)
              resourceGroupName: $(ResourceGroupName)
              csmFile: resources/main.bicep

      - job: DeployDevRoles
        displayName: Deploy Roles to RG
        steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              deploymentScope: 'Resource Group'
              connectedServiceName: $(ServiceConnectionName)
              location: $(DeploymentDefaultLocation)
              resourceGroupName: $(ResourceGroupName)
              csmFile: resources/roles.bicep
              overrideParameters: '-devScope $(devScope)'

      - job: DeployDevBudget
        displayName: Deploy Basic Budget
        steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              deploymentScope: 'Resource Group'
              connectedServiceName: $(ServiceConnectionName)
              location: $(DeploymentDefaultLocation)
              resourceGroupName: $(ResourceGroupName)
              csmFile: resources/budget.bicep

      - job: DeployDevKeyVault
        displayName: Deploy Key Vault Bicep
        steps:
          - task: AzureResourceManagerTemplateDeployment@3
            inputs:
              deploymentScope: 'Resource Group'
              connectedServiceName: $(ServiceConnectionName)
              location: $(DeploymentDefaultLocation)
              resourceGroupName: $(ResourceGroupName)
              csmFile: resources/keyVault.bicep
              overrideParameters: '-tenantId $(tenantId)'