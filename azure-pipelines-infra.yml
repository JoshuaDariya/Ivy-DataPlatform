# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- none

pool:
  vmImage: ubuntu-latest

variables:
- group: InfraPipelinelVars
- group: SubscriptionVars

stages:
  - stage: Dev Deployment
    displayName: Deploy Dev Infrastructure
    jobs:
      - job: DeployInfrastructure
      displayName: Deploy Infrastructure Bicep
      steps:
        - task: AzureResourceManagerTemplateDeployment@3
          displayName: 'Deploy Infrastructure Bicep'
          inputs:
            deploymentScope: 'Resource Group'
            connectedServiceName: $(ServiceConnectionName)
            location: $(DeploymentDefaultLocation)
            resourceGroupName: $(ResourceGroupName)
            csmFile: resources/main.bicep
            # overrideParameters: >
            #   -environmentType $(EnvironmentType)

      #Task for focusing on roles and permissions
      - job: DeployDevRoles
        displayName: Deploy Dev Role Bicep
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          displayName: 'Deploy Roles to RG'
          inputs:
            deploymentScope: 'Resource Group'
            connectedServiceName: $(ServiceConnectionName)
            location: $(DeploymentDefaultLocation)
            resourceGroupName: $(ResourceGroupName)
            csmFile: resources/roles.bicep
            overrideParameters: '-devScope $(devScope)'

      #Task for focusing on budget
      - job: DeployDevBudget
        displayName: Deploy Dev Budget Bicep
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          displayName: 'Deploy Basic Budget'
          inputs:
            deploymentScope: 'Resource Group'
            connectedServiceName: $(ServiceConnectionName)
            location: $(DeploymentDefaultLocation)
            resourceGroupName: $(ResourceGroupName)
            csmFile: resources/budget.bicep

      #Task for creating key vault
      - job: DeployDevKeyVault
        displayName: Deploy Dev Key Vault Bicep
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          displayName: 'Deploy Key Vault Bicep'
          inputs:
            deploymentScope: 'Resource Group'
            connectedServiceName: $(ServiceConnectionName) #'$(InfraPipelinelVars.ServiceConnectionName)'
            location: '$(DeploymentDefaultLocation)'
            resourceGroupName: '$(ResourceGroupName)'
            csmFile: resources/keyVault.bicep
            overrideParameters: '-tenantId $(tenantId)'
      
